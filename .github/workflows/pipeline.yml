name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: NUCLEAR - Clean everything
      run: |
        docker system prune -a -f
        sudo rm -rf /var/lib/docker/overlay2/*
    
    - name: Build Docker image (ABSOLUTELY NO CACHE)
      run: |
        docker build \
          --no-cache \
          --pull \
          --build-arg CACHE_BUSTER=$(date +%s) \
          -t devsecops-app .
    
    - name: VERIFY - Check installed versions
      run: |
        echo "=== VERIFICAÃ‡ÃƒO DE VERSÃ•ES ==="
        docker run --rm devsecops-app pip list | grep -E "(jaraco|flask|requests)"
        docker run --rm devsecops-app python -c "
        import jaraco.context
        print(f'jaraco.context: {jaraco.context.__version__}')
        assert jaraco.context.__version__ == '6.1.0', 'VERSÃƒO ERRADA!'
        "
    
    - name: Scan with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: devsecops-app
        severity: CRITICAL,HIGH
        exit-code: 1
        format: table
        ignore-unfixed: false
    
    - name: CELEBRATE! ðŸŽ‰
      if: success()
      run: |
        echo "âœ…âœ…âœ… PIPELINE PASSOU! âœ…âœ…âœ…"
        echo "ðŸŽ‰ jaraco.context estÃ¡ na versÃ£o 6.1.0"
        echo "ðŸš€ Pipeline DevSecOps FUNCIONANDO!"
