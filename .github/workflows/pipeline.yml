name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Clean Docker
      run: docker system prune -a -f
    
    - name: Build Docker image
      run: |
        docker build \
          --no-cache \
          --pull \
          --build-arg CACHE_BUSTER=$(date +%s) \
          -t devsecops-app .
    
    - name: Verify jaraco.context version
      run: |
        echo "=== VERIFICA√á√ÉO DE VERS√ÉO ==="
        VERSION=$(docker run --rm devsecops-app pip show jaraco.context | grep Version | awk '{print $2}')
        echo "jaraco.context version: $VERSION"
        if [ "$VERSION" = "6.1.0" ]; then
          echo "‚úÖ VERS√ÉO CORRETA: 6.1.0"
        else
          echo "‚ùå VERS√ÉO INCORRETA: $VERSION"
          exit 1
        fi
    
    - name: Scan with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: devsecops-app
        severity: CRITICAL,HIGH
        exit-code: 1
        format: table
        ignore-unfixed: false
    
    - name: Success! üéâ
      if: success()
      run: |
        echo "‚úÖ‚úÖ‚úÖ PIPELINE DEVSECOPS FUNCIONANDO! ‚úÖ‚úÖ‚úÖ"
